<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coin Puzzle</title>

  <style>
    :root{
      --w: 512px;
      --gap: 8px;

      --bg: #0e3a37;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(0,0,0,.12);

      --tileBg: #0b7c74;
      --targetBg: #f2c22a;
      --targetText: #111;
      --frame: #0a2f2d;

      --btnBg: #1bc7a6;
      --btnText: #083a34;
    }

    *{ box-sizing: border-box; }

    body{
      margin:0;
      background: var(--bg);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Meiryo", sans-serif;
      color: #fff;
      display:flex;
      justify-content:center;
    }

    .app{
      width: min(var(--w), 92vw);
      padding: 14px 12px 20px;
    }

    .header{
      width: 100%;
      border-radius: 12px;
      overflow:hidden;
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      margin-bottom: 12px;
    }
    .header img{
      width:100%;
      height:auto;
      display:block;
    }

    .controls{
      display:flex;
      gap: 10px;
      margin: 10px 0 10px;
    }
    button{
      flex:1;
      border:0;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 16px;
      font-weight: 700;
      background: var(--btnBg);
      color: var(--btnText);
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
      cursor:pointer;
      -webkit-tap-highlight-color: transparent;
    }
    button:active{
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(0,0,0,.22);
    }

/* ===== 画像ボタン用（Play / Reset） ===== */
button.imgBtn{
  padding: 0;
  background: transparent;
  box-shadow: none;
  border-radius: 14px;
  overflow: hidden;
  cursor: pointer;
}

button.imgBtn img{
  width: 100%;
  height: auto;
  display: block;
}

button.imgBtn:active{
  transform: translateY(1px) scale(0.98);
}

button.imgBtn:focus-visible{
  outline: 3px solid rgba(255,255,255,.75);
  outline-offset: 2px;
}

    .statusbar{
      background: var(--panel);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 0 0 12px;
      box-shadow: 0 8px 18px rgba(0,0,0,.20);
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      align-items:center;
    }
    .status-left{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      font-size: 13px;
      opacity: .95;
    }
    .chip{
      background: var(--panel2);
      border-radius: 999px;
      padding: 6px 10px;
      line-height: 1;
      white-space:nowrap;
    }
    .clear{
      font-weight: 900;
      letter-spacing: .5px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.18);
      display:none;
    }
    .clear.show{ display:inline-flex; }

    .status-right{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    select{
      border: 0;
      border-radius: 10px;
      padding: 8px 10px;
      background: rgba(255,255,255,.10);
      color:#fff;
      font-weight: 700;
      cursor:pointer;
      outline:none;
    }
    option{ color:#111; }

    /* 盤面ラッパー（CLEARオーバーレイを重ねる） */
    .boardWrap{
      position: relative;
    }

    .board{
      width: 100%;
      display:grid;
      grid-template-columns: 1fr 1fr 1fr 1fr;
      gap: var(--gap);
      background: rgba(0,0,0,.08);
      padding: var(--gap);
      border-radius: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
    }

    /* 左上角（画像） */
    .corner{
      background: rgba(255,255,255,.08);
      border-radius: 12px;
      min-height: 70px;
      padding: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.08);
      user-select:none;
      overflow:hidden;
    }
    .corner img{
      width: 100%;
      height: 100%;
      object-fit: contain;    /* 正方形キャンバスなら綺麗に収まる */
      display:block;
      border-radius: 10px;
      pointer-events:none;
    }

    .target{
      background: var(--targetBg);
      color: var(--targetText);
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 900;
      font-size: 34px;
      letter-spacing: .5px;
      box-shadow: inset 0 0 0 3px rgba(0,0,0,.06);
      user-select:none;
    }

    .cell{
      background: var(--frame);
      border-radius: 12px;
      padding: 6px;
      display:flex;
      align-items:center;
      justify-content:center;
      aspect-ratio: 1 / 1;
    }

    .tile{
      width:100%;
      height:100%;
      border-radius: 10px;
      background: var(--tileBg);
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      cursor:pointer;
      position:relative;

      outline:none;
      user-select:none;
      -webkit-user-select:none;
      -webkit-tap-highlight-color: transparent;
    }

    .tile img{
      width: 92%;
      height: auto;
      display:block;
      pointer-events:none;
    }

    .tile:active{
      transform: scale(0.995);
      filter: brightness(0.98);
    }

    .tile:focus{ outline:none; }
    .tile:focus-visible{
      outline: 3px solid rgba(255,255,255,.75);
      outline-offset: 2px;
    }

    /* CLEAR オーバーレイ */
    .overlay{
      position:absolute;
      inset: 0;
      border-radius: 14px;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(0,0,0,.45);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 5;
      user-select:none;
    }
    .overlay.show{
      display:flex;
    }
    .overlayCard{
      padding: 18px 22px;
      border-radius: 18px;
      background: rgba(255,255,255,.14);
      box-shadow: 0 16px 34px rgba(0,0,0,.35);
      text-align:center;
    }
    .clearImg{
      width: min(340px, 78vw);
      height: auto;
      display:block;
      margin: 0 auto;
    }
    .overlaySub{
      margin-top: 10px;
      font-size: 13px;
      opacity: .95;
    }

    @media (max-width: 420px){
      .target{ font-size: 28px; }
      button{ font-size: 15px; }
    }
.copyright{
  margin: 14px 0 0;
  text-align: center;
  font-size: 14px;
  color: rgba(255,255,255,.6);
}

.copyright .note{
  display: block;
  margin-top: 2px;
  font-size: 13px;
  color: rgba(255,255,255,.45);
}

  </style>
</head>

<body>
  <div class="app">
    <div class="header">
      <img src="images/header.png" alt="Coin Puzzle header">
    </div>

    <div class="controls">
  <button id="btnPlay" type="button" class="imgBtn" aria-label="Play">
    <img src="images/btn_play.png" alt="Play">
  </button>

  <button id="btnReset" type="button" class="imgBtn" aria-label="Reset">
    <img src="images/btn_reset.png" alt="Reset">
  </button>
</div>


    <div class="statusbar">
      <div class="status-left">
        <span class="chip" id="chipLevel">LEVEL: Normal</span>
        <span class="chip" id="chipMoves">Moves: 0</span>
        <span class="clear" id="clearBadge">CLEAR!</span>
      </div>
      <div class="status-right">
        <select id="levelSelect" aria-label="難易度">
          <option value="easy">Easy（1,5,10,50）</option>
          <option value="normal" selected>Normal（1〜500）</option>
          <option value="hard">Hard（100/500多め）</option>
        </select>
      </div>
    </div>

    <div class="boardWrap">
      <div class="overlay" id="clearOverlay" aria-hidden="true" title="クリック/タップで閉じる">
        <div class="overlayCard">
          <!-- ★ ここが画像CLEAR -->
          <img src="images/clear.png" alt="CLEAR!" class="clearImg">
          <div class="overlaySub">クリック/タップで閉じる</div>
        </div>
      </div>

      <div class="board" id="board">
        <!-- ★ 左上角を画像で埋める -->
        <div class="corner">
          <img src="images/corner.png" alt="Target Sum">
        </div>

        <div class="target" id="tTop0">-</div>
        <div class="target" id="tTop1">-</div>
        <div class="target" id="tTop2">-</div>

        <div class="target" id="tLeft0">-</div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="0"><img alt="" id="img0"></div></div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="1"><img alt="" id="img1"></div></div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="2"><img alt="" id="img2"></div></div>

        <div class="target" id="tLeft1">-</div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="3"><img alt="" id="img3"></div></div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="4"><img alt="" id="img4"></div></div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="5"><img alt="" id="img5"></div></div>

        <div class="target" id="tLeft2">-</div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="6"><img alt="" id="img6"></div></div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="7"><img alt="" id="img7"></div></div>
        <div class="cell"><div class="tile" role="button" tabindex="0" data-i="8"><img alt="" id="img8"></div></div>
      </div>
    </div>
      <footer class="copyright">
        © 2026 Michio Inaba / Coin Puzzle
        <span class="note">PowerPoint × Web App</span>
      </footer>

</div>

  <script>
    const IMG = {
      empty: "images/coin_empty.png",
      1: "images/coin_1.png",
      5: "images/coin_5.png",
      10: "images/coin_10.png",
      50: "images/coin_50.png",
      100: "images/coin_100.png",
      500: "images/coin_500.png",
    };

    const ORDER = [null, 1, 5, 10, 50, 100, 500];

    const imgEls = Array.from({length:9}, (_,i)=>document.getElementById("img"+i));
    const topEls = [0,1,2].map(i => document.getElementById("tTop"+i));
    const leftEls = [0,1,2].map(i => document.getElementById("tLeft"+i));

    const levelSelect = document.getElementById("levelSelect");
    const chipLevel = document.getElementById("chipLevel");
    const chipMoves = document.getElementById("chipMoves");
    const clearBadge = document.getElementById("clearBadge");
    const clearOverlay = document.getElementById("clearOverlay");

    let moves = 0;
    
    let clearShowTimer = null;
    let clearHideTimer = null;
    const CLEAR_SHOW_DELAY = 900;   // 出てくるまで(ms)
    const CLEAR_KEEP_TIME  = 2500;  // 表示保持(ms)
    let player = Array(9).fill(null);
    let answer = Array(9).fill(1);
    let targetTop = [0,0,0];
    let targetLeft = [0,0,0];

    function coinsByLevel(level){
      if(level === "easy")   return [1,5,10,50];
      if(level === "hard")   return [1,5,10,50,100,100,500,500];
      return [1,5,10,50,100,500];
    }

    function updateLevelChip(){
      const v = levelSelect.value;
      chipLevel.textContent = "LEVEL: " + (v === "easy" ? "Easy" : v === "hard" ? "Hard" : "Normal");
    }

    function setImg(i, value){
      imgEls[i].src = (value === null) ? IMG.empty : IMG[value];
      imgEls[i].alt = (value === null) ? "未選択" : (value + "円");
    }

    function renderPlayer(){
      for(let i=0;i<9;i++) setImg(i, player[i]);
    }

    function calcTargetsFromAnswer(){
      targetTop = [0,0,0];
      for(let c=0;c<3;c++){
        targetTop[c] = answer[c] + answer[c+3] + answer[c+6];
      }
      targetLeft = [0,0,0];
      for(let r=0;r<3;r++){
        const idx = r*3;
        targetLeft[r] = answer[idx] + answer[idx+1] + answer[idx+2];
      }
    }

    function renderTargets(){
      topEls.forEach((el,i)=> el.textContent = targetTop[i]);
      leftEls.forEach((el,i)=> el.textContent = targetLeft[i]);
    }

    function randCoin(level){
      const pool = coinsByLevel(level);
      return pool[Math.floor(Math.random()*pool.length)];
    }

    function resetClearUI(){
      clearBadge.classList.remove("show");
      clearOverlay.classList.remove("show");
      clearOverlay.setAttribute("aria-hidden","true");
      if(clearShowTimer){ clearTimeout(clearShowTimer); clearShowTimer=null; }
      if(clearHideTimer){ clearTimeout(clearHideTimer); clearHideTimer=null; }
    }

    function showClearOverlayDelayed(){
      if(clearShowTimer || clearOverlay.classList.contains("show")) return;
      clearShowTimer = setTimeout(()=>{
        clearOverlay.classList.add("show");
        clearOverlay.setAttribute("aria-hidden","false");
        clearShowTimer = null;

        clearHideTimer = setTimeout(()=>{
          clearOverlay.classList.remove("show");
          clearOverlay.setAttribute("aria-hidden","true");
          clearHideTimer = null;
        }, CLEAR_KEEP_TIME);

      }, CLEAR_SHOW_DELAY);
    }

    function setMoves(n){
      moves = n;
      chipMoves.textContent = "Moves: " + moves;
    }

    function newPuzzle(){
      updateLevelChip();
      const level = levelSelect.value;

      answer = Array.from({length:9}, () => randCoin(level));
      calcTargetsFromAnswer();
      renderTargets();

      player = Array(9).fill(null);
      renderPlayer();

      setMoves(0);
      resetClearUI();
    }

    function resetPuzzle(){
      player = Array(9).fill(null);
      renderPlayer();

      setMoves(0);
      resetClearUI();
    }

    function nextValue(v){
      const idx = ORDER.indexOf(v);
      if(idx === -1) return 1;
      if(idx === 0) return 1;
      if(idx === ORDER.length-1) return 1;
      return ORDER[idx+1];
    }

    function currentSums(){
      const val = i => (player[i] ?? 0);

      const top = [0,0,0];
      for(let c=0;c<3;c++){
        top[c] = val(c) + val(c+3) + val(c+6);
      }

      const left = [0,0,0];
      for(let r=0;r<3;r++){
        const idx = r*3;
        left[r] = val(idx) + val(idx+1) + val(idx+2);
      }
      return { top, left };
    }

    function checkClear(){
      if(topEls[0].textContent === "-") return false;

      const sums = currentSums();
      const okTop = sums.top.every((v,i)=> v === targetTop[i]);
      const okLeft = sums.left.every((v,i)=> v === targetLeft[i]);

      const cleared = okTop && okLeft;

      if(cleared){
        clearBadge.classList.add("show");
        showClearOverlayDelayed();
      }else{
        clearBadge.classList.remove("show");
        clearOverlay.classList.remove("show");
        clearOverlay.setAttribute("aria-hidden","true");
      }
      return cleared;
    }

    function handleTileActivate(i){
      player[i] = nextValue(player[i]);
      setImg(i, player[i]);

      setMoves(moves + 1);
      checkClear();
    }

    document.querySelectorAll(".tile").forEach(tile=>{
      tile.addEventListener("click", ()=>{
        const i = Number(tile.dataset.i);
        handleTileActivate(i);
      });

      tile.addEventListener("keydown", (e)=>{
        if(e.key === "Enter" || e.key === " "){
          e.preventDefault();
          const i = Number(tile.dataset.i);
          handleTileActivate(i);
        }
      });
    });

    // CLEARオーバーレイはクリック/タップで閉じる
    clearOverlay.addEventListener("click", ()=>{
      clearOverlay.classList.remove("show");
      clearOverlay.setAttribute("aria-hidden","true");
      if(clearShowTimer){ clearTimeout(clearShowTimer); clearShowTimer=null; }
      if(clearHideTimer){ clearTimeout(clearHideTimer); clearHideTimer=null; }
    });

    document.getElementById("btnPlay").addEventListener("click", newPuzzle);
    document.getElementById("btnReset").addEventListener("click", resetPuzzle);

    levelSelect.addEventListener("change", ()=>{
      updateLevelChip();
    });

    updateLevelChip();
    renderPlayer();
    setMoves(0);
  </script>
</body>
</html>
